/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    simsendx/SEQUIFOX Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
----------------------------------------------------------------------------------------
*/

manifest {
    name                       = 'simsendx/SEQUIFOX'
    author                     = 'Stefan Filges'
    homePage                   = 'https://github.com/simsendx/SEQUIFOX'
    description                = 'SEQUIFOX: Pipeline for ultrasensitive analysis of STR markers from targeted sequencing data'
    mainScript                 = 'main.nf'
    nextflowVersion            = '!>=24.10.4'
    version                    = '0.1.3'
}

params {
    // Basic parameters
    samplesheet                = null         // Three-column csv: sample, fastq_1, fastq_2
    library_file               = null         // Defines STR markers
    bed_file                   = null         // Genomic coordinates of 
    ini_file                   = null         // Pipeline initilisation file for fdstools
    fasta                      = 's3://ngi-igenomes/igenomes/Homo_sapiens/GATK/GRCh38/Sequence/WholeGenomeFasta/Homo_sapiens_assembly38.fasta'
    bwa_index                  = null         // Pre-indexed reference fasta
    outdir                     = 'results'
    publish_dir_mode           = 'copy'
    validate_params            = true
    mode                       = null          // Analysis mode: If 'fgbio' runs fgbio consensus workflow, otherwise run 'umiec' consensus

    // Preprocessing parameters
    fastp_save_merged          = true          // Whether to merge paired fastq files
    umi_length                 = 19            // Length of UMI, incl. 'non-random' based interspersed such as NNNACTNNN
    spacer_length              = 16            // Spacer between UMI and primer
    min_read_length            = 75           // Min length of (merged) reads to keep after fastp

    // FASTP - UMI extraction
    fastp_umi                  = false         // enable UMI preprocessing with fastp
    fastp_umiloc               = 'read1'       // specify the location of UMI, can be (index1/index2/read1/read2/per_index/per_read, default is none. 

    // FASTP - Base correction by overlap analysis options
    correction                 = true          // if true, will perform correction of overlapped reads
    overlap_len_require        = 50           // the minimum length to detect overlapped region of PE read
    overlap_diff_limit         = 5             // the maximum number of mismatched bases to detect overlapped region of PE reads
    overlap_diff_percent_limit = 20            // maximum percentage of mismatched bases to detect overlapped region of PE reads

    // FGBIO parameters
    read_structures            = '19M16S+T'    // For details, see: https://github.com/fulcrumgenomics/fgbio/wiki/Read-Structures
    groupreadsbyumi_strategy   = 'adjacency'   // One of: 'adjacency', 'identity', 'paired', 'edit'
    groupreadsbyumi_edits      = 1             // The allowable number of edits between UMIs.
    call_min_reads             = 3             // default minimum input reads for fgbio's CALL*CONSENSUSREADS tools
    call_min_baseq             = 10            // default minimum input base quality for fgbio's CALL*CONSENSUSREADS tools
    filter_max_base_error_rate = 0.1           // default maximum raw-read error rate for fgbio's FILTERCONSENSUSREADS
    min_mapping_quality        = 20            // Minimum mapping quality for mapped reads. Default is 20.
    include_non_pf_reads       = false         // Include non-PF reads. Default is false.

    // FDStools parameters
    indel_score                = 2             // insertions and deletions in the flanking sequences are penalised this number of times more heavily than mismatches
    mismatches                 = 0.1           //  number of mismatches (per nucleotide of flanking sequence if less than 1, else absolute) to allow in flanking sequences
    consensus_method           = 'most_common' // One of: 'most_common', 'position', 'MSA'
}

profiles {
    arm {
        docker.runOptions      = '-u $(id -u):$(id -g) --platform=linux/amd64'
        podman.runOptions      = '--platform=linux/amd64'
    }
    
    conda {
        conda.enabled          = true
        docker.enabled         = false
        singularity.enabled    = false
        podman.enabled         = false
    }

    docker {
        docker.enabled         = true
        podman.enabled         = false
        singularity.enabled    = false
    }

    podman {
        docker.enabled         = false
        podman.enabled         = true
        singularity.enabled    = false
    }

    singularity {
        docker.enabled         = false
        podman.enabled         = false
        singularity.enabled    = true
    }
}

// Nextflow plugins
plugins {
  id 'nf-schema@2.4.1'
}

validation {
    help {
        enabled = true
    }
}

// Load base.config by default
includeConfig 'conf/base.config'